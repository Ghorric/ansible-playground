---
- name: Create the DinD network infrastructure
  hosts: all
  connection: local
  tasks:
  - name: dockerVersion
    command: "docker --version"
    register: dockerVersionOutput
  - debug: msg="{{ dockerVersionOutput.stdout }}"
  - name: dockerPs
    command: "docker ps"
    register: dockerPsOutput
  - debug: msg="{{ dockerPsOutput.stdout }}"
  - name: dockerLoad
    command: "docker load -i /home/docker-karaf-ssh.dimg"
    register: dockerLoadOutput
  - debug: msg="{{ dockerLoadOutput.stdout }}"
  - name: dockerPs2
    command: "docker ps"
    register: dockerPs2Output
  - debug: msg="{{ dockerPs2Output.stdout }}"
  - name: Docker create network
    command: "docker network create --subnet=172.27.0.0/16 net01"
    register: createNetworkOutput
  - debug: msg="{{ createNetworkOutput.stdout }}"
  - name: Docker run server-karaf01 
    docker_container:
      name: server-karaf01
      hostname: server-karaf01
      image: wengle/docker-karaf-ssh
      networks:
        - name: "bridge"
      state: started 
  - name: dockerPs3
    command: "docker ps"
    register: dockerPs3Output
  - debug: msg="{{ dockerPs3Output.stdout }}"
  - name: Add to hosts
    command: "sh /home/scripts/ContainerIpToHosts.sh server-karaf01"
  - name: pingKaraf01
    command: "ping -w3 server-karaf01"
    register: pingKaraf01Output
  - debug: msg="{{ pingKaraf01Output.stdout }}"
  - name: pingInfinite
    command: "ping localhost"
    register: pingInfiniteOutput
  - debug: msg="{{ pingInfiniteOutput.stdout }}"